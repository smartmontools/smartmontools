#
# smartmontools drive database update script for Windows
#
# Home page of code is: https://www.smartmontools.org
#
# Copyright (C) 2022-25 Christian Franke
#
# SPDX-License-Identifier: GPL-2.0-or-later
#

<#
  .SYNOPSIS
  Update smartmontools @VERSION@ drive database.

  .DESCRIPTION
  update-smart-drivedb.ps1 updates SCRIPTDIR/drivedb.h from
  branch 'drivedb/@DRIVEDB_BRANCH@' of smartmontools git repository.

  The downloaded file is verified with OpenPGP/GPG key ID 721042C5.
  The public key block is included in the script.

  .PARAMETER Smartctl
  Use this smartctl executable for syntax check ('-Smartctl -' to
  disable).  The default is smartctl.exe in script directory.

  .PARAMETER UrlOf
  Use the URL of one of the following locations for download:
    github (upstream git repository)
    svn (previous SVN repository)
    trac (Trac code browser)
  The default is 'github'.

  .PARAMETER Url
  Download from this URL.  A valid OpenPGP/GPG signature with '[.raw].asc'
  extension must also exist unless '-NoVerify' is also specified.

  .PARAMETER File
  Copy from local file.  A valid OpenPGP/GPG signature 'FILE[.raw].asc'
  must also exist unless '-NoVerify' is also specified.

  .PARAMETER Main
  Download from main branch.  This requires '-NoVerify' because these
  versions are not signed.

  .PARAMETER Branch
  If '-Branch X.Y' is specified, download from branch X.Y.

  .PARAMETER Insecure
  Don't abort download if certificate verification fails.
  This requires PowerShell >= 6.0.

  .PARAMETER NoVerify
  Don't verify signature with GnuPG.

  .PARAMETER Force
  Allow downgrades.  By default, the database is not replaced with an
  older version of the same branch.

  .PARAMETER ExportKey
  Print the OpenPGP/GPG public key block.

  .PARAMETER DryRun
  Print download commands only.

  .PARAMETER Quiet
  Suppress info messages.

  .PARAMETER Drivedb
  Destination drive database file.
  The default is drivedb.h in script directory.

  .EXAMPLE
  update-smart-drivedb.ps1
  /INSTALLPATH/drivedb.h 7.5/5701 updated to 7.5/5706

  (Regular update)

  .EXAMPLE
  update-smart-drivedb.ps1 -Force -File /INSTALLPATH/drivedb.h.old
  /INSTALLPATH/drivedb.h 7.5/5706 downgraded to 7.5/5701

  (Revert to previous version)

  .EXAMPLE
  update-smart-drivedb -Main -NoVerify -Smartctl - drivedb-main.h
  drivedb-main.h 7.5/? newly installed (NOT VERIFIED)

  (Download the database from main branch to current directory)

  .LINK
  https://www.smartmontools.org/
#>

param (
  [string]$Smartctl,
  [string]$UrlOf,
  [string]$Url,
  [string]$File,
  [switch]$Main,
  [string]$Branch,
  [switch]$Insecure,
  [switch]$NoVerify,
  [switch]$Force,
  [switch]$ExportKey,
  [switch]$DryRun,
  [switch]$Quiet,
 #[switch]$Verbose, # Common parameter
  [Parameter(Position=0)][string]$Drivedb
)

$ErrorActionPreference = "Stop"

# Set by config.status
# Default drivedb.h update branch
$default_branch="@DRIVEDB_BRANCH@"

# GnuPG used to verify signature (disabled if empty)
$gpg = "@gnupg@"

# Name and Directory of this script
$myname = $MyInvocation.MyCommand.Name
$mydir = Split-Path -Path $MyInvocation.MyCommand.Source
if (!$mydir) {
  throw "Unknown script directory"
}

# Default drivedb location
$default_drivedb = "$mydir\drivedb.h"

# Default command used for syntax check
$default_smartctl = "$mydir\smartctl"

function error($message)
{
  # Echo error messages to stdout because 'Write-Error'
  # always writes a full 'ErrorRecord' to stderr.
  echo "${myname}: $message"
  exit 1
}

function warning($message)
{
  echo "${myname}: (Warning) $message"
}

function iecho($message)
{
  if (!$script:Quiet) {
    echo $message
  }
}

function vecho($message)
{
  $message | Write-Verbose
}

function test_f($file)
{
  return Test-Path -PathType Leaf -LiteralPath $file
}

function touch($file)
{
  vecho "Touch '$file'"
  (Get-Item $file).LastWriteTime = Get-Date
}

function cmp($file1, $file2)
{
  if (!(     (Test-Path -PathType Leaf -LiteralPath $file1) `
        -and (Test-Path -PathType Leaf -LiteralPath $file2))) {
    return $false
  }
  return (Get-FileHash $file1).hash -eq (Get-FileHash $file2).hash
}

function rm_f # FILE...
{
  foreach ($file in $args) {
    if (Test-Path -PathType Leaf -LiteralPath $file) {
      vecho "Remove-Item '$file'"
      Remove-Item $file
    }
  }
}

function rm_rf($dir)
{
  if (Test-Path -PathType Container -LiteralPath $dir) {
    vecho "Remove-Item -Recurse '$dir'"
    Remove-Item -Recurse $dir
  }
}

function mv_f($oldfile, $newfile)
{
  rm_f $newfile
  vecho "Move-Item '$oldfile' '$newfile'"
  Move-Item $oldfile $newfile
}

function selecturl($url_of, [ref]$url)
{
  switch ($url_of) {
    'github' {
       #    https://github.com/smartmontools/smartmontools/raw/refs/heads/main/lib/drivedb.h
       #    redirected to:
       $u = 'https://raw.githubusercontent.com/smartmontools/smartmontools/refs/heads/main/lib/drivedb.h'
     }
    'svn'  { $u = 'https://svn.code.sf.net/p/smartmontools/code/trunk/smartmontools/drivedb.h' }
    'trac' { $u = 'https://www.smartmontools.org/browser/lib/drivedb.h?format=raw&rev=main' }
    default { error "${url_of}: is none of 'github svn trac'" }
  }
  $url.Value = $u
}

function vcopy($src, $dest)
{
  if ($script:DryRun) {
    echo "Copy-Item '$src' '$dest'"
  } else {
    vecho "Copy-Item '$src' '$dest'"
    Copy-Item $src $dest
  }
}

function download($url, $file, [ref]$errmsg)
{
  $req = @{ Uri = $url; OutFile = $file; MaximumRedirection = 0 }
  if ($script:Insecure) {
    # #Requires -Version 6
    $req += @{ SkipCertificateCheck = $true }
  }

  $errmsg.Value = ""
  if ($script:DryRun) {
    echo "Invoke-WebRequest $(echo @req)"
  } else {
    vecho "Invoke-WebRequest $(echo @req)"
    try {
      Invoke-WebRequest @req
    } catch {
      if ($_.Exception.Message) {
        $errmsg.Value = $_.Exception.Message
      } else {
        $errmsg.Value = "Unknown error"
      }
    }
  }
}

function check_file($file, $firstchar, $minsize, $maxsize)
{
  # Check file size
  $size = (Get-Item -LiteralPath $file).Length
  if ($size -lt $minsize) {
    return "too small file size $size bytes"
  }
  if ($size -gt $maxsize) {
    return "too large file size $size bytes"
  }

  # Check first chars
  switch ((Get-Content -LiteralPath $file -TotalCount 1).ToCharArray()[0]) {
    "$firstchar" { }
    "<" { return "HTML error message" }
    default { return "unknown file contents" }
  }

  return ""
}

function selectkey($branch, [ref]$key)
{
  switch -RegEx ($branch) {
    '^7\.[0235]$' {
# Smartmontools DriveDB Key (through 2030) <smartmontools-support@listi.jpberlin.de>
# Smartmontools Signing Key (through 2025) <smartmontools-database@listi.jpberlin.de>
# Smartmontools Signing Key (through 2020) <smartmontools-database@listi.jpberlin.de>
# Key ID 721042C5
      $key.Value = `
'-----BEGIN PGP PUBLIC KEY BLOCK-----

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
gOPOIi6Mx23Yg8qeYw==
=Kp7v
-----END PGP PUBLIC KEY BLOCK-----
'
    }

    default {
      error "No known public key for branch '${branch}'"
    }
  }
}

function run_join_out_err($cmd) # ARG...
{
  # Don't prepend $input with BOM
  $enc = [Console]::InputEncoding
  [Console]::InputEncoding = [System.Text.UTF8Encoding]::new()
  $ErrorActionPreference = "Continue" # Don't abort command on first stderr output
  $LASTEXITCODE = 42
  # Run command and convert ErrorRecords from stderr to plain Strings
  try {
    $($input | & $cmd @args 2>&1) | %{ $_.ToString() }
  } catch {
    error "$_"
  }
  $ErrorActionPreference = "Stop"
  [Console]::InputEncoding = $enc
}

function gpg_verify($ascfile, $file, [ref]$ok)
{
  # Create temp home dir path
  if (!$env:TEMP) { error "Environment variable TEMP is not set" }
  $gnupgtmp = Join-Path $env:TEMP "gnupg.$(New-Guid)"

  # Convert path if Cygwin or MSYS2 version of GnuPG is used
  if ($gpg_cygpath) {
    $gnupgtmp_cyg = & $gpg_cygpath $gnupgtmp
    if (!$gnupgtmp_cyg) { error "$gpg_cygpath '$gnupgtmp': failed" }
  } else {
    $gnupgtmp_cyg = $gnupgtmp
  }

  # Create temp home dir
  rm_rf $gnupgtmp
  vecho "New-Item -ItemType Directory -Path '$gnupgtmp'"
  New-Item -ItemType Directory -Path $gnupgtmp | Out-Null

  # Import public key
  $env:LC_MESSAGES = "C"
  $out = ($public_key | run_join_out_err $gpg "--batch" "--no-tty" "--homedir=$gnupgtmp_cyg" "--import")
  if ($LASTEXITCODE -ne 0) {
    echo $out
    exit 1
  }
  vecho $out

  # Verify
  $out = run_join_out_err $gpg "--batch" "--no-tty" "--homedir=$gnupgtmp_cyg" "--verify" $ascfile $file
  if ($LASTEXITCODE -eq 0) {
    vecho $out
    $ok.Value = $true
  } else {
    # print gpg error always
    echo $out
    $ok.Value = $false
  }

  # Stop the gpg-agent possibly started by gpg
  if ($gpgconf) {
    $out = run_join_out_err $gpgconf "--homedir=$gnupgtmp_cyg" "--kill" "gpg-agent"
    if ($LASTEXITCODE -ne 0) {
      echo $out
    }
  }

  # Remove temp home dir
  try {
    rm_rf "$gnupgtmp"
  } catch {
    warning "$_"
  }
}

function get_db_version($file)
{
  $v = (Select-String -CaseSensitive -Pattern '^[ {]*"VERSION: .*"' -Path $file).Line `
       -replace '^[ {]*"VERSION: ([1-9][./0-9]*)[ "].*$','$1'
  if ($v -match '^[1-9][.0-9]*$') {
    return "$v/?"
  } elseif ($v -match '^[1-9][./0-9]*$') {
    return $v
  } else {
    return ""
  }
}

function drivedb_mv($old, $new)
{
  foreach ($ext in ("", ".asc", ".raw", ".raw.asc")) {
    $of = "${Drivedb}${old}${ext}"
    $nf = "${Drivedb}${new}${ext}"
    if (test_f $of) {
      mv_f $of $nf
    } else {
      rm_f $nf
    }
  }
}

function drivedb_error($message)
{
  drivedb_mv ".new" ".error"
  error "${Drivedb}.error${message}"
}

# Set defaults
if (!$Smartctl) {
  $Smartctl = $default_smartctl
}

if ($Branch) {
  if (!($Branch -match '^5\.4[0-3]|6\.[0-6]|7\.[0235]$')) {
    error "invalid branch '${Branch}'"
  }
} else {
  $Branch = $default_branch
}

if (!$Drivedb) {
  $Drivedb = $default_drivedb
}

if ($ExportKey) {
  $key = ""
  selectkey $Branch ([ref]$key)
  echo $key
  exit 0
}

# Check selected source
if (!$Url -and !$File) {
  if (!$UrlOf) {
    $UrlOf = "github"
  }
  $Url = ""
  selecturl $UrlOf ([ref]$Url)
  if ($Url -match '/main/|rev=main') {
      if (!$Main) {
        $Url = $Url -replace "/main/","/drivedb/$Branch/" `
                    -replace "rev=main","rev=drivedb/$Branch"
        if ($Branch -match '^[567]\.') {
         $Url = $Url -replace '/lib/','/smartmontools/'
        }
      } elseif (!$NoVerify) {
        error "'-Main' requires '-NoVerify'"
      }
  } elseif ($Url -match '/trunk/') {
    if ($Main) {
      error "'-Main' is not supported with '-UrlOf svn'"
    }
    $Url = $Url -replace "/trunk/","/branches/RELEASE_${Branch}_DRIVEDB/" `
                -replace '_([0-9]*)\.([0-9]*)_','_$1_$2_'`
  } else {
    error "${Url}: Invalid URL (internal)"
  }
} elseif (!$UrlOf -and $Url -and !$File) {
  if (!($Url -match '^[a-z][a-z0-9]*:[^ ][^ ]*$')) {
    error "${Url}: Invalid URL"
  }
} elseif (!$UrlOf -and !$Url -and $File) {
} else {
  error "only one of '-UrlOf', '-Url', '-File' is allowed"
}

# Determine path of signature file
$FileAsc = ""
$FileRawAsc = ""
$UrlAsc = ""
if (!$NoVerify) {
  if ($Url) {
    if ($Branch -match '^[567]\.') {
      $raw = ".raw";
    } else {
      $raw = "";
    }
    if ($Url -match '\?') {
      $UrlAsc = $Url -replace '\?',"${raw}.asc?"
    } else {
      $UrlAsc = "${Url}${raw}.asc"
    }
  } else {
    $FileAsc = "${File}.asc"
    $FileRawAsc = "${File}.raw.asc"
  }
}

# Check for smartctl
if ($Smartctl -ne "-") {
  if (!(Get-Command -Type Application -Name $Smartctl -TotalCount 1 -ErrorAction Ignore)) {
    error "${Smartctl}: not found ('-Smartctl -' to ignore)"
  }
}

# Check for GnuPG
$gpgconf = ""
$gpg_cygpath = ""
if (!$NoVerify) {
  $gpgobj = $null
  if ($gpg) {
    $gpgobj = Get-Command -Type Application -Name $gpg -TotalCount 1 -ErrorAction Ignore
  }
  if (!$gpgobj) {
    error "GnuPG is not available ('-NoVerify' to ignore)"
  }
  $public_key = ""
  selectkey $Branch ([ref]$public_key)

  # Check for 'gpgconf' in same directory
  $gpgpath = Split-Path ($gpgobj[0]).Source
  $gpgconf = "gpgconf"
  $gpgconfobj = Get-Command -Type Application -Name $gpgconf -TotalCount 1 -ErrorAction Ignore
  if (!($gpgconfobj -and ($gpgpath -eq (Split-Path ($gpgconfobj[0]).Source)))) {
    $gpgconf = ""
  }

  # Assume Cygwin or MSYS2 version of GnuPG if 'cygpath' is in same directory
  $gpg_cygpath = "cygpath"
  $gpg_cygpathobj = Get-Command -Type Application -Name $gpg_cygpath -TotalCount 1 -ErrorAction Ignore
  if (!($gpg_cygpathobj -and ($gpgpath -eq (Split-Path ($gpg_cygpathobj[0]).Source)))) {
    $gpg_cygpath = ""
  }

  vecho "'$gpg'$(if ($gpgconf) { " and '$gpgconf'" })$(if ($gpg_cygpath) { " and '$gpg_cygpath'" }) found in: $gpgpath"
}

# Remove possible garbage from last download
if (!$DryRun) {
  rm_f "${Drivedb}.new" "${Drivedb}.new.asc" "${Drivedb}.new.raw" "${Drivedb}.new.raw.asc"
}

if ($Url) {
  # Download
  vecho "Download drivedb.h"
  $errmsg = ""
  download $Url "${Drivedb}.new" ([ref]$errmsg)
  if ($errmsg) {
    rm_f "${Drivedb}.new"
    error "drivedb.h: download failed: $errmsg"
  }

  if ($UrlAsc) {
    vecho "Download drivedb.h.asc"
    download $UrlAsc "${Drivedb}.new.asc" ([ref]$errmsg)
    if ($errmsg) {
      rm_f "${Drivedb}.new" "${Drivedb}.new.asc"
      error "drivedb.h.asc: download failed: $errmsg ('-NoVerify' to ignore)"
    }
  }
} else {
  # Copy from local file
  if (!(test_f $File)) {
    error "${File}: file not found"
  }
  if ($FileAsc) {
    if (!(test_f $FileAsc)) {
      if (!(test_f $FileRawAsc)) {
        error "${FileAsc}, ${FileRawAsc}: file not found ('-NoVerify' to ignore)"
      }
      $FileAsc = $FileRawAsc
    }
  }

  vcopy $File "${Drivedb}.new"
  if ($FileAsc) {
    vcopy $FileAsc "${Drivedb}.new.asc"
  }
}

if ($DryRun) {
  exit 0
}

# Check files and adjust timestamps
$errmsg = check_file "${Drivedb}.new" '/' 10000 1000000
if ($errmsg) {
  drivedb_error ": $errmsg"
}
touch "${Drivedb}.new"

if (test_f "${Drivedb}.new.asc") {
  $errmsg = check_file "${Drivedb}.new.asc" '-' 200 2000
  if ($errmsg) {
    drivedb_error ".asc: $errmsg"
  }
  touch "${Drivedb}.new.asc"
}

# Check whether installed file is identical
$equal = cmp "${Drivedb}" "${Drivedb}.new"

if (!$NoVerify) {
  # Verify new file
  $ok = $false
  gpg_verify "${Drivedb}.new.asc" "${Drivedb}.new" ([ref]$ok)
  if (!$ok) {
    if ($equal) {
      warning "${Drivedb}: *** installed file is identical to broken new file ***"
    }
    drivedb_error ": *** BAD signature or outdated key ***"
  }
}

# Get version
$newver = get_db_version "${Drivedb}.new"
if (!$newver) {
  if (!$Force) {
    drivedb_error ": no VERSION information found ('-Force' to ignore)"
  }
  $newver = "?/?"
} elseif ($newver -match '/\?$') {
  if (!$Main) {
    drivedb_error ": VERSION information is incomplete ('-Main' to ignore)"
  }
}

if ($Smartctl -ne "-") {
  # Check syntax
  run_join_out_err $Smartctl -B "${Drivedb}.new" -P showall | Out-Null
  if (!$?) {
    drivedb_error ": rejected by $Smartctl, probably no longer compatible"
  }
  vecho "${Smartctl}: syntax OK"
}

# Always install if missing
rm_f "${Drivedb}.lastcheck"
if (!(Test-Path -PathType Leaf -Path $Drivedb)) {
  drivedb_mv ".new" ""
  iecho "$Drivedb $newver newly installed$(if ($NoVerify) {" (NOT VERIFIED)"})"
  exit 0
}

# Keep old file if identical
if ($equal) {
  if (test_f "${Drivedb}.new.asc") {
    if (!(cmp "${Drivedb}.new.asc" "${Drivedb}.asc")) {
      mv_f "${Drivedb}.new.asc" "${Drivedb}.asc"
      iecho "${Drivedb}.asc $newver updated"
    }
  }
  rm_f "${Drivedb}.new" "${Drivedb}.new.asc" "${Drivedb}.raw" "${Drivedb}.raw.asc"
  vecho "New-Item '${Drivedb}.lastcheck'"
  New-Item -ItemType File -Path "${Drivedb}.lastcheck" | Out-Null
  iecho "$Drivedb $newver is already up to date$(if ($NoVerify) {" (NOT VERIFIED)"})"
  exit 0
}

# Check branch and file version
$oldver = $(get_db_version "${Drivedb}")
if (!$oldver) {
  $oldver = "?/?"
}
if (    ($newver -match '/\?$') `
    -or ($oldver -match '/\?$') `
    -or (($newver -replace '/.*$','') -ne ($oldver -replace '/.*$',''))) {
  # Always install if from main or other branch
  $updmsg = "replaced with"
} elseif ((($newver -replace '^.*/','') - ($oldver -replace '^.*/','')) -lt 0) {
  # Install older file only if '-Force' is used
  if (!$Force) {
    rm_f "${Drivedb}.new" "${Drivedb}.new.asc"
    iecho "$Drivedb $oldver not downgraded to $newver ('-Force' to override)"
    exit 0
  }
  $updmsg = "downgraded to"
} else {
  $updmsg = "updated to"
}

drivedb_mv "" ".old"
drivedb_mv ".new" ""
iecho "$Drivedb $oldver $updmsg $newver$(if ($NoVerify) {" (NOT VERIFIED)"})"
exit 0
