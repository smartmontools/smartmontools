#! /bin/sh
#
# smartmontools drive database update script
#
# Home page of code is: https://www.smartmontools.org
#
# Copyright (C) 2010-25 Christian Franke
#
# SPDX-License-Identifier: GPL-2.0-or-later
#

set -e

# Set by config.status
@ENABLE_SCRIPTPATH_TRUE@export PATH="@scriptpath@"
PACKAGE="@PACKAGE@"
VERSION="@VERSION@"
prefix="@prefix@"
exec_prefix="@exec_prefix@"
sbindir="@sbindir@"
datarootdir="@datarootdir@"
datadir="@datadir@"
# shellcheck disable=SC2034
localstatedir="@localstatedir@"
drivedbinstdir="@drivedbinstdir@"
drivedbdir="@drivedbdir@"

# Download tools
os_dltools="@os_dltools@"

# Default drivedb.h update branch
default_branch="@DRIVEDB_BRANCH@"

# Default drivedb location
default_drivedb="$drivedbdir/drivedb.h"

# GnuPG used to verify signature (disabled if empty)
gpg="@gnupg@"

# Default command used for syntax check
default_smartctl="$sbindir/smartctl"

# PATH information for help and error messages
@ENABLE_SCRIPTPATH_FALSE@pathinfo='$PATH'
@ENABLE_SCRIPTPATH_TRUE@pathinfo="'$PATH'"

myname=$0

print_help()
{
@ENABLE_SCRIPTPATH_TRUE@  pathinfo="
@ENABLE_SCRIPTPATH_TRUE@                     $pathinfo"
  cat <<EOF
smartmontools $VERSION drive database update script

Usage: $myname [OPTIONS] [DESTFILE]

  -s, --smartctl SMARTCTL
                    Use SMARTCTL for syntax check ('-s -' to disable)
                    [default: $default_smartctl]
  -t, --tool [DIR/]TOOL
                    Use TOOL for download: $os_dltools
                    [default: first one found in $pathinfo]
  -u, --url-of LOCATION
                    Use URL of LOCATION for download:
                      github (upstream git repository) [default]
                      svn (previous SVN repository)
                      trac (Trac code browser)
  --url URL         Download from URL
  --file FILE       Copy from local FILE
EOF
  test "$drivedbinstdir" = "$drivedbdir" || cat <<EOF
  --install         Copy from originally installed drive database file
                    This is the same as:
                    '--no-verify --file $drivedbinstdir/drivedb.h'
EOF
  cat <<EOF
  --main            Download from main branch (requires '--no-verify')
  --branch X.Y      Download from branch X.Y
  --cacert FILE     Use CA certificates from FILE to verify the peer
  --capath DIR      Use CA certificate files from DIR to verify the peer
  --insecure        Don't abort download if certificate verification fails
  --no-verify       Don't verify signature
  --force           Allow downgrades
  --export-key      Print the OpenPGP/GPG public key block
  --dryrun          Print download commands only
  -q, --quiet       Suppress info messages
  -v, --verbose     Verbose output
  -h, --help        Print this help text

Updates $default_drivedb
or DESTFILE from branch 'drivedb/$default_branch' of smartmontools git
repository.
EOF
}

error()
{
  echo "$myname: $*" >&2
  test -z "$usageerr" || echo "Try '$myname -h' for help" >&2
  exit 1
}

err_notfound()
{
  case $1 in
    */*) error "$1: not found $2" ;;
    *)   error "$1: not found in $pathinfo $2" ;;
  esac
}

# check_optarg "$@"
check_optarg()
{
  test $# -gt 1 || error "option '$1' requires an argument"
}

warning()
{
  echo "$myname: (Warning) $*" >&2
}

# selecturl URL_OF
selecturl()
{
  case $1 in
    github) # https://github.com/smartmontools/smartmontools/raw/refs/heads/main/lib/drivedb.h
            # redirected to:
            url='https://raw.githubusercontent.com/smartmontools/smartmontools/refs/heads/main/lib/drivedb.h' ;;
    svn)    url='https://svn.code.sf.net/p/smartmontools/code/trunk/smartmontools/drivedb.h' ;;
    trac)   url='https://www.smartmontools.org/browser/lib/drivedb.h?format=raw&rev=main' ;;
    *) error "$1: is none of 'github svn trac'"
  esac
}

inpath()
{
  local d rc save
  rc=1
  save=$IFS
  IFS=':'
  for d in $PATH; do
    test -f "$d/$1" || continue
    test -x "$d/$1" || continue
    rc=0
    break
  done
  IFS=$save
  return $rc
}

iecho()
{
  test -n "$quiet" || echo "$*"
}

vecho()
{
  test -n "$q" || echo "$*"
}

# vrun COMMAND ARGS...
vrun()
{
  if [ -n "$dryrun" ]; then
    echo "$*"
  elif [ -n "$q" ]; then
    "$@" 2>/dev/null
  else
    echo "$*"
    "$@"
  fi
}

# vrun2 OUTFILE COMMAND ARGS...
vrun2()
{
  local f err rc
  f=$1; shift
  rc=0
  if [ -n "$dryrun" ]; then
    echo "$* > $f"
  else
    vecho "$* > $f"
    err=`"$@" 2>&1 > $f` || rc=$?
    if [ -n "$err" ]; then
      vecho "$err" >&2
      test $rc != 0 || rc=42
    fi
  fi
  return $rc
}

# rm_f FILE...
rm_f()
{
  while [ $# -ne 0 ]; do
    if [ -f "$1" ]; then
      vrun rm -f "$1"
    fi
    shift
  done
}

# download URL FILE
download()
{
  local f u rc
  u=$1; f=$2
  rc=0

  case ${tool##*/} in
    curl*)
      # "Accept-Encoding" header avoids caching problems with svn URL
      vrun "$tool" ${q:+-s} -f --max-redirs 0 \
        -H "Accept-Encoding: identity" \
        ${cacert:+--cacert "$cacert"} \
        ${capath:+--capath "$capath"} \
        ${insecure:+--insecure} \
        -o "$f" "$u" || rc=$?
      ;;

    wget*)
      # wget >= 1.16.1 sets "Accept-Encoding: identity" header by default
      vrun "$tool" $q --max-redirect=0 \
        ${cacert:+--ca-certificate="$cacert"} \
        ${capath:+--ca-directory="$capath"} \
        ${insecure:+--no-check-certificate} \
        -O "$f" "$u" || rc=$?
      ;;

    lynx*)
      test -z "$cacert" || vrun export SSL_CERT_FILE="$cacert"
      test -z "$capath" || vrun export SSL_CERT_DIR="$capath"
      # Check also stderr as lynx does not return != 0 on HTTP error
      vrun2 "$f" "$tool" -stderr -noredir -source "$u" || rc=$?
      ;;

    fetch*) # FreeBSD
      vrun "$tool" $q --no-redirect \
        ${cacert:+--ca-cert "$cacert"} \
        ${capath:+--ca-path "$capath"} \
        ${insecure:+--no-verify-hostname} \
        -o "$f" "$u" || rc=$?
      ;;

    ftp*) # OpenBSD
      vrun "$tool" \
        ${cacert:+-S cafile="$cacert"} \
        ${capath:+-S capath="$capath"} \
        ${insecure:+-S dont} \
        -o "$f" "$u" || rc=$?
      ;;

    *) error "$tool: unknown (internal error)" ;;
  esac
  return $rc
}

# check_file FILE FIRST_CHAR MIN_SIZE MAX_SIZE
check_file()
{
  local firstchar f maxsize minsize size
  f=$1; firstchar=$2; minsize=$3; maxsize=$4

  # Check first chars
  # shellcheck disable=SC2254
  case `dd if="$f" bs=1 count=1 2>/dev/null` in
    $firstchar) ;;
    \<) echo "HTML error message"; return 1 ;;
    *)   echo "unknown file contents"; return 1 ;;
  esac

  # Check file size
  size=`wc -c < "$f"`
  if test "$size" -lt $minsize; then
    echo "too small file size $size bytes"
    return 1
  fi
  if test "$size" -gt $maxsize; then
    echo "too large file size $size bytes"
    return 1
  fi
  return 0
}

# selectkey BRANCH
selectkey()
{
  case $1 in
    7.[0235])
# Smartmontools DriveDB Key (through 2030) <smartmontools-support@listi.jpberlin.de>
# Smartmontools Signing Key (through 2025) <smartmontools-database@listi.jpberlin.de>
# Smartmontools Signing Key (through 2020) <smartmontools-database@listi.jpberlin.de>
# Key ID 721042C5
public_key="\
-----BEGIN PGP PUBLIC KEY BLOCK-----

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
gOPOIi6Mx23Yg8qeYw==
=Kp7v
-----END PGP PUBLIC KEY BLOCK-----
"
      ;;

    *) error "No known public key for branch '$1'" ;;
  esac
}

# gpg_verify FILE.asc FILE
gpg_verify()
{
  local gnupgtmp i out rc

  # Create temp home dir
  gnupgtmp="$tmpdir/.gnupg.$$.tmp"
  rm -f -r "$gnupgtmp"
  mkdir "$gnupgtmp" || exit 1
  chmod 0700 "$gnupgtmp"

  # Import public key
  if ! out=`echo "$public_key" | "$gpg" --batch --no-tty --homedir="$gnupgtmp" --import 2>&1`; then
    echo "$out" >&2
    exit 1
  fi
  vecho "$out"

  # Verify
  rc=0
  out=`"$gpg" --batch --no-tty --homedir="$gnupgtmp" --verify "$1" "$2" </dev/null 2>&1` || rc=1
  if [ $rc = 0 ]; then
    vecho "$out"
  else
    # print gpg error always
    echo "$out" >&2
  fi

  # Stop the gpg-agent possibly started by gpg
  if [ -n "$gpgconf" ]; then
    out=`"$gpgconf" --homedir="$gnupgtmp" --kill gpg-agent </dev/null 2>&1` || echo "$out" >&2
  fi

  # Remove temp home dir, retry on failure
  i=0
  while ! out=`rm -f -r "$gnupgtmp" 2>&1`; do
    i=$((i+1))
    if [ $i -ge 10 ]; then
      echo "$out" >&2; break
    fi
    vecho "$out"
    sleep 1
  done

  return $rc
}

# get_db_version DRIVEDB > VERSION
get_db_version()
{
  local v
  v=`sed -n '/^[ {]*"VERSION: .*"/{
       s,^[ {]*"VERSION: \([1-9][./0-9]*\)[ "].*$,\1,p
       q
     }' "$1"` || return 1
  test -n "$v" || return 0
  test "${v%/*}" != "$v" || v="$v/?"
  echo "$v"
}

# drivedb_mv OLD NEW
drivedb_mv()
{
  local ext nf of
  for ext in "" ".asc" ".raw" ".raw.asc"; do
    of="${drivedb}${1}${ext}"
    nf="${drivedb}${2}${ext}"
    if [ -f "$of" ]; then
      vrun mv -f "$of" "$nf"
    else
      rm_f "$nf"
    fi
  done
}

# drivedb_error "MESSAGE"
drivedb_error()
{
  drivedb_mv ".new" ".error"
  error "${drivedb}.error${1}"
}

# Parse options
smartctl=$default_smartctl
tool=
url_of=
url=
file=
quiet=
q="-q"
dryrun=
main=
branch=$default_branch
cacert=
capath=
insecure=
no_verify=
force=
expkey=
usageerr=t

while true; do case $1 in
  -s|--smartctl)
    check_optarg "$@"; shift
    smartctl=$1 ;;

  -t|--tool)
    check_optarg "$@"; shift
    tool=$1 ;;

  -u|--url-of)
    check_optarg "$@"; shift
    url_of=$1 ;;

  -q|--quiet)
    quiet=t ;;

  -v|--verbose)
    q= ;;

  --url)
    check_optarg "$@"; shift
    url=$1 ;;

  --file)
    check_optarg "$@"; shift
    file=$1 ;;

  --install)
    test "$drivedbinstdir" != "$drivedbdir" \
    || error "'$1' is not supported in this configuration"
    file="$drivedbinstdir/drivedb.h"
    no_verify=t ;;

  --dryrun)
    dryrun=t ;;

  --main)
    main=t ;;

  --branch)
    check_optarg "$@"; shift
    branch=$1
    case $branch in
      5.4[0-3]|6.[0-6]|7.[0235]) ;;
      *) error "invalid branch '$branch'" ;;
    esac ;;

  --cacert)
    check_optarg "$@"; shift
    cacert=$1 ;;

  --capath)
    check_optarg "$@"; shift
    capath=$1 ;;

  --insecure)
    insecure=t ;;

  --no-verify)
    no_verify=t ;;

  --force)
    force=t ;;

  --export-key)
    expkey=t ;;

  -h|--help)
    print_help
    exit 0 ;;

  -*)
    error "unknown option '$1'" ;;

  *)
    break ;;
esac; shift; done

if [ -n "$expkey" ]; then
  selectkey "$branch"
  cat <<EOF
$public_key
EOF
  exit 0
fi

case $# in
  0) drivedb=$default_drivedb ;;
  1) drivedb=$1 ;;
  *) error "only one DESTFILE argument is allowed" ;;
esac

# Check selected source
case "${url_of:+url_of}${url:+url}${file:+file}" in
  ''|url_of)
    test -n "$url_of" || url_of=github
    selecturl "$url_of"
    case $url in
      */main/*|*rev=main*)
        if [ -z "$main" ]; then
          url=`echo "$url" | sed -e "s,/main/,/drivedb/$branch/," \
                                 -e "s,rev=main,rev=drivedb/$branch,"`
          case $branch in
            [567].*) url=`echo "$url" | sed -e 's,/lib/,/smartmontools/,'` ;;
          esac
        elif [ -z "$no_verify" ]; then
          error "'--main' requires '--no-verify'"
        fi
        ;;
      */trunk/*)
        test -z "$main" || error "'--main' is not supported with '-u svn'"
        url=`echo "$url" | sed -e "s,/trunk/,/branches/RELEASE_${branch}_DRIVEDB/," \
                               -e 's,_\([0-9]*\)\.\([0-9]*\)_,_\1_\2_,'`;;
      *) error "$url: invalid URL (internal)" ;;
    esac ;;
  url)
    test -z "`echo "$url" | sed -e 's,^[a-z][a-z0-9]*:[^ ][^ ]*$,,'`" \
    || error "$url: Invalid URL" ;;
  file) ;;
  *) error "only one of '-u', '--url', '--file' is allowed" ;;
esac

# Determine path of signature file
file_asc=
file_raw_asc=
url_asc=
if [ -z "$no_verify" ]; then
  if [ -n "$url" ]; then
    case $branch in
      [567].*) raw=".raw" ;;
      *) raw= ;;
    esac
    case $url in
      *\?*) url_asc=`echo "$url" | sed "s,?,$raw.asc?,"` ;;
      *)    url_asc="$url$raw.asc" ;;
    esac
  else
    file_asc="$file.asc"
    file_raw_asc="$file.raw.asc"
  fi
fi

if [ -z "$file" ]; then
  if [ -z "$tool" ]; then
    # Find download tool in PATH
    for t in $os_dltools; do
      if inpath "$t"; then
        tool=$t
        break
      fi
    done
    test -n "$tool" || error "found none of '$os_dltools' in $pathinfo"
  else
    # Check tool name
    found=
    for t in $os_dltools; do
      case ${tool##*/} in
        $t*) found=t; break ;;
      esac
    done
    test -n "$found" || error "$tool: is none of '$os_dltools'"
  fi
fi

# Check option compatibility
case "$tool:$insecure" in
  lynx:t) warning "'--insecure' is ignored if '-t lynx' is used" ;;
esac

# Check for smartctl
if [ "$smartctl" != "-" ]; then
  "$smartctl" -V >/dev/null 2>&1 \
  || err_notfound "$smartctl" "('-s -' to ignore)"
fi

# Check for GnuPG
gpgconf=
if [ -z "$no_verify" ]; then
  test -n "$gpg" \
  || error "GnuPG is not available ('--no-verify' to ignore)"
  "$gpg" --version >/dev/null 2>&1 \
  || err_notfound "$gpg" "('--no-verify' to ignore)"
  selectkey "$branch"
  case $gpg in
    */*) gpgconf="${gpg%/*}/gpgconf" ;;
    *) gpgconf="gpgconf" ;;
  esac
  "$gpgconf" --version >/dev/null 2>&1 || gpgconf=
fi
usageerr=

# Use destination directory as temp directory for gpg
tmpdir=`dirname "$drivedb"`

# Remove possible garbage from last download
rm_f "$drivedb.new" "$drivedb.new.asc" "$drivedb.new.raw" "$drivedb.new.raw.asc" || exit 1

if [ -n "$url" ]; then
  # Download
  vecho "Download drivedb.h with $tool"
  rc=0
  download "$url" "$drivedb.new" || rc=$?
  if [ $rc != 0 ]; then
    rm_f "$drivedb.new"
    error "drivedb.h: download failed ($tool: exit $rc)"
  fi

  if [ -n "$url_asc" ]; then
    vecho "Download drivedb.h.asc with $tool"
    rc=0
    download "$url_asc" "$drivedb.new.asc" || rc=$?
    if [ $rc != 0 ]; then
      rm_f "$drivedb.new" "$drivedb.new.asc"
      error "drivedb.h.asc: download failed ($tool: exit $rc) ('--no-verify' to ignore)"
    fi
  fi
else
  # Copy from local file
  if [ ! -f "$file" ]; then
    error "$file: file not found"
  fi
  if [ -n "$file_asc" ]; then
    if [ ! -f "$file_asc" ]; then
      test -f "$file_raw_asc" \
      || error "$file_asc, $file_raw_asc: file not found ('--no-verify' to ignore)"
      file_asc=$file_raw_asc
    fi
  fi

  if ! vrun cp "$file" "$drivedb.new"; then
    error "$file: copy failed"
  fi
  if [ -n "$file_asc" ]; then
    if ! vrun cp "$file_asc" "$drivedb.new.asc"; then
      rm_f "$drivedb.new"
      error "$file_asc: copy failed"
    fi
  fi
fi

test -z "$dryrun" || exit 0

# Check files, adjust timestamps and permissions
errmsg=`check_file "$drivedb.new" '/' 10000 1000000` \
|| drivedb_error ": $errmsg"
touch "$drivedb.new"
chmod 0644 "$drivedb.new"

if [ -f "$drivedb.new.asc" ]; then
  errmsg=`check_file "$drivedb.new.asc" '-' 200 2000` \
  || drivedb_error ".asc: $errmsg"
  touch "$drivedb.new.asc"
  chmod 0644 "$drivedb.new.asc"
fi

# Check whether installed file is identical
equal=t
cmp "$drivedb" "$drivedb.new" >/dev/null 2>&1 || equal=

if [ -z "$no_verify" ]; then
  # Verify new file
  if ! gpg_verify "$drivedb.new.asc" "$drivedb.new"; then
    test -z "$equal" \
    || warning "$drivedb: *** installed file is identical to broken new file ***"
    drivedb_error ": *** BAD signature or outdated key ***"
  fi
fi

# Get version
newver=`get_db_version "$drivedb.new"`
if [ -z "$newver" ]; then
  test -n "$force" \
  || drivedb_error ": no VERSION information found ('--force' to ignore)"
  newver="?/?"
elif [ "${newver##*/}" = "?" ]; then
  test -n "$main" \
  || drivedb_error ": VERSION information is incomplete ('--main' to ignore)"
fi

if [ "$smartctl" != "-" ]; then
  # Check syntax
  "$smartctl" -B "$drivedb.new" -P showall >/dev/null \
  || drivedb_error ": rejected by $smartctl, probably no longer compatible"
  vecho "$smartctl: syntax OK"
fi

# Always install if missing
rm -f "$drivedb.lastcheck"
if [ ! -f "$drivedb" ]; then
  drivedb_mv ".new" ""
  iecho "$drivedb $newver newly installed${no_verify:+ (NOT VERIFIED)}"
  exit 0
fi

# Keep old file if identical
if [ -n "$equal" ]; then
  if    [ -f "$drivedb.new.asc" ] \
     && ! cmp "$drivedb.new.asc" "$drivedb.asc" >/dev/null 2>&1; then
    vrun mv -f "$drivedb.new.asc" "$drivedb.asc"
    iecho "$drivedb.asc $newver updated"
  fi
  rm_f "$drivedb.new" "$drivedb.new.asc" "$drivedb.raw" "$drivedb.raw.asc"
  touch "$drivedb.lastcheck"
  iecho "$drivedb $newver is already up to date${no_verify:+ (NOT VERIFIED)}"
  exit 0
fi

# Check branch and file version
oldver=`get_db_version "$drivedb"`
test -n "$oldver" || oldver="?/?"
if    [ "${newver##*/}" = "?" ] \
   || [ "${oldver##*/}" = "?" ] \
   || [ "${newver%/*}" != "${oldver%/*}" ]; then
  # Always install if from main or other branch
  updmsg="replaced with"
elif [ "${newver##*/}" -lt "${oldver##*/}" ]; then
  # Install older file only if '--force' is used
  if [ -z "$force" ]; then
    rm_f "$drivedb.new" "$drivedb.new.asc"
    iecho "$drivedb $oldver not downgraded to $newver ('--force' to override)"
    exit 0
  fi
  updmsg="downgraded to"
else
  updmsg="updated to"
fi

drivedb_mv "" ".old"
drivedb_mv ".new" ""
iecho "$drivedb $oldver $updmsg $newver${no_verify:+ (NOT VERIFIED)}"
